# Order Progress Tracking System

This document describes the implementation of the 7-step order progress tracking system as specified in the requirements.

## Overview

The order progress tracking system provides a comprehensive solution for tracking orders through a predefined 7-step process with real-time updates and conditional logic for handling cancellations.

## System Architecture

### Database Schema

The system uses a new `order_progress_steps` table to track individual step statuses:

```sql
CREATE TABLE order_progress_steps (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    step_number INTEGER NOT NULL CHECK (step_number >= 1 AND step_number <= 7),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'completed', 'canceled')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    completed_at TIMESTAMP WITH TIME ZONE,
    canceled_at TIMESTAMP WITH TIME ZONE,
    UNIQUE(order_id, step_number)
);
```

### Database Functions

1. **`initialize_order_progress_steps(order_id UUID)`** - Creates the 7 predefined steps for a new order
2. **`update_order_progress_step(p_order_id UUID, p_step_number INTEGER, p_status VARCHAR)`** - Updates step status with conditional logic
3. **`sync_order_progress_with_status(p_order_id UUID)`** - Syncs progress steps with existing order status

### Automatic Triggers

The system includes automatic triggers that:
- Initialize progress steps when a new order is created
- Sync progress steps when order status changes
- Apply conditional cancellation logic

## The 7-Step Process

1. **Checkout Request Placed** - User places an order (immediately completed)
2. **Invoice Generated by Admin** - Admin generates custom invoice
3. **User Decision (Accepted / Declined)** - User reviews and accepts/declines invoice
4. **PayPal Credentials Shared** - Admin shares payment instructions
5. **User Payment Submitted** - User submits payment
6. **Admin Payment Verification** - Admin verifies payment
7. **Order Confirmed** - Order confirmed after payment verification

## Conditional Logic

### Invoice Declined (Step 3)
- If user declines invoice, steps 3-7 are automatically canceled
- Steps 1-2 remain completed

### Payment Rejected (Step 6)
- If admin rejects payment verification, steps 6-7 are automatically canceled
- Steps 1-5 remain completed

## API Endpoints

### OrderProgressService Methods

```typescript
// Initialize progress for new order
OrderProgressService.initializeOrderProgress({ order_id: string })

// Get current progress
OrderProgressService.getOrderProgress(orderId: string)

// Update step status
OrderProgressService.updateProgressStep({
  order_id: string,
  step_number: number,
  status: 'pending' | 'completed' | 'canceled'
})

// Sync with order status
OrderProgressService.syncOrderProgress(orderId: string)

// Subscribe to real-time updates
OrderProgressService.subscribeToOrderProgressUpdates(orderId, callback)
```

## Frontend Components

### OrderProgressTracker
Main component for displaying the 7-step progress:

```tsx
<OrderProgressTracker 
  orderId="order-uuid"
  showRefresh={true}
  allowAdminActions={false}
/>
```

### Enhanced TrackOrderTimeline
Updated existing component with backward compatibility:

```tsx
<TrackOrderTimeline 
  orderStatus="pending_admin_review"
  orderId="order-uuid"
  useEnhancedTracking={true}
/>
```

## Real-time Updates

The system provides real-time updates through Supabase subscriptions:

```typescript
const unsubscribe = OrderProgressService.subscribeToOrderProgressUpdates(
  orderId,
  (update) => {
    console.log('Progress updated:', update);
    // Handle update
  }
);
```

## Type Safety

Comprehensive TypeScript types are provided:

```typescript
interface OrderProgressStep {
  id: string;
  order_id: string;
  step_number: number;
  title: string;
  description: string | null;
  status: 'pending' | 'completed' | 'canceled';
  created_at: string;
  updated_at: string;
  completed_at: string | null;
  canceled_at: string | null;
}

interface OrderProgressTracking {
  order_id: string;
  steps: OrderProgressStep[];
  overall_status: 'in_progress' | 'completed' | 'canceled';
  total_steps: number;
  completed_steps: number;
  progress_percentage: number;
  last_updated: string;
}
```

## Usage Examples

### Integration with Existing Order Flow

The system integrates seamlessly with the existing order tracking:

```tsx
// In OrderTracking.tsx
<TrackOrderTimeline 
  orderStatus={orderDetails.status}
  orderId={orderDetails.id}
  useEnhancedTracking={true}
/>
```

### Admin Dashboard Integration

For admin interfaces, enable admin actions:

```tsx
<OrderProgressTracker 
  orderId={orderId}
  allowAdminActions={true}
  showRefresh={true}
/>
```

## Demo

A comprehensive demo is available at `/order-progress-demo` showcasing:
- All 7 steps in various states
- Conditional cancellation scenarios
- Real-time progress visualization
- System features overview

## Security

- Row Level Security (RLS) policies protect access to progress data
- Users can only view progress for their own orders
- Admins can view and modify all order progress
- Database functions use `SECURITY DEFINER` for controlled access

## Performance

- Indexed columns for efficient queries
- Optimized for real-time subscriptions
- Minimal database roundtrips
- Caching-friendly data structure

## Testing

The system includes:
- Build-time TypeScript validation
- Runtime Zod schema validation
- Demo scenarios for manual testing
- Integration with existing order system

## Migration

The system includes a migration file:
`supabase/migrations/20250127000001_create_order_progress_tracking.sql`

This migration:
- Creates the new table and indexes
- Sets up RLS policies
- Creates database functions
- Adds automatic triggers

## Backward Compatibility

The enhanced system maintains full backward compatibility with the existing order tracking system. The `TrackOrderTimeline` component can optionally use the new 7-step system while falling back to the original implementation when needed.